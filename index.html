<!DOCTYPE html>
<html class="h-full">
<head>
    <title>Agent Chat</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .prose pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .prose code { background: #f1f5f9; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875em; }
        .prose pre code { background: none; padding: 0; }
        .tool-item { margin: 0.25rem 0; }
        .tool-call { display: block; background: #fef3c7; border-left: 3px solid #f59e0b; padding: 0.25rem 0.5rem; border-radius: 0 0.25rem 0.25rem 0; font-family: monospace; font-size: 0.75rem; color: #92400e; cursor: pointer; }
        .tool-call.tool-warn { background: #fee2e2; border-color: #ef4444; color: #991b1b; cursor: default; }
        .tool-details { background: #0f172a; color: #e2e8f0; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.25rem; overflow-x: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.75rem; }
        @keyframes pulse { 0%, 80%, 100% { opacity: 0.3; } 40% { opacity: 1; } }
        .loading span { animation: pulse 1.4s infinite; }
        .loading span:nth-child(2) { animation-delay: 0.2s; }
        .loading span:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body class="h-full bg-gray-100 text-gray-900 antialiased">
    <div class="flex flex-col h-full">
        <div class="sticky top-0 z-10 flex items-center justify-between border-b bg-white/80 px-4 py-3 backdrop-blur">
            <h1 class="text-base font-semibold text-gray-900">Agent Chat</h1>
            <button onclick="reset()" class="rounded-lg px-3 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-100">Reset</button>
        </div>
        <div id="messages" class="flex-1 overflow-y-auto">
            <div class="mx-auto w-full max-w-3xl px-4 py-6 space-y-6" id="messagesInner"></div>
        </div>
        <div class="border-t bg-white/80 p-4 backdrop-blur">
            <div class="max-w-3xl mx-auto flex items-center gap-2 rounded-2xl border border-gray-200 bg-white px-3 py-2 shadow-sm">
                <input type="text" id="input" placeholder="Send a message..." onkeypress="if(event.key==='Enter')send()" autofocus class="flex-1 bg-transparent px-2 py-2 text-sm focus:outline-none">
                <button onclick="send()" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-xl hover:bg-gray-800">Send</button>
            </div>
        </div>
    </div>
    <script>
        const messagesInner = document.getElementById('messagesInner');
        const input = document.getElementById('input');
        const STORAGE_KEY = 'agentChatHistory_v1';
        let history = [];
        marked.setOptions({ breaks: true, gfm: true });

        async function reset() {
            await fetch('/reset', { method: 'POST' });
            history = [];
            localStorage.removeItem(STORAGE_KEY);
            messagesInner.innerHTML = '<div class="text-center text-gray-400 italic py-8">Session reset</div>';
        }

        async function send() {
            const text = input.value.trim();
            if (!text) return;
            input.value = '';

            appendUserMessage(text, true);

            const loader = document.createElement('div');
            loader.className = 'flex justify-start loading';
            loader.innerHTML = '<div class="rounded-2xl border border-gray-200 bg-white px-4 py-3 text-gray-400 shadow-sm"><span>‚óè</span><span>‚óè</span><span>‚óè</span></div>';
            messagesInner.appendChild(loader);
            scroll();

            const response = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text }) });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let raw = '', responseDiv = null;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                for (const line of decoder.decode(value).split('\n')) {
                    if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        if (!responseDiv) {
                            loader.remove();
                            responseDiv = appendAssistantMessage('', false);
                        }
                        try { raw += JSON.parse(line.slice(6)); } catch { raw += line.slice(6); }
                        responseDiv.innerHTML = renderContent(raw);
                        scroll();
                    }
                }
            }

            if (responseDiv) {
                history.push({ role: 'assistant', text: raw });
                saveHistory();
            }
        }

        function renderContent(text) {
            const withToolCalls = text
                .replace(/\[Using ([^|\]]+)\|([A-Za-z0-9+/=]+)\]/g, (_, name, b64) => {
                    const decoded = decodeBase64Utf8(b64);
                    const detail = formatToolInput(decoded);
                    const safeName = escapeHtml(name);
                    const safeDetail = escapeHtml(detail);
                    return `\n<details class="tool-item"><summary class="tool-call">üîß ${safeName}</summary><pre class="tool-details"><code>${safeDetail}</code></pre></details>\n`;
                })
                .replace(/\[Using ([^\]]+)\.\.\.\]/g, (_, name) => `\n<div class="tool-item"><span class="tool-call">üîß ${escapeHtml(name)}</span></div>\n`)
                .replace(/\[‚ö†Ô∏è Permission: ([^\]]+)\]/g, (_, name) => `\n<div class="tool-item"><span class="tool-call tool-warn">‚ö†Ô∏è ${escapeHtml(name)}</span></div>\n`);
            return marked.parse(withToolCalls);
        }

        function appendUserMessage(text, persist) {
            const msg = document.createElement('div');
            msg.className = 'flex justify-end';
            msg.innerHTML = `<div class="max-w-[75%] rounded-2xl bg-gray-900 px-4 py-2.5 text-white shadow-sm">${escapeHtml(text)}</div>`;
            messagesInner.appendChild(msg);
            if (persist) {
                history.push({ role: 'user', text });
                saveHistory();
            }
            scroll();
        }

        function appendAssistantMessage(raw, persist) {
            const msg = document.createElement('div');
            msg.className = 'flex justify-start';
            msg.innerHTML = '<div class="max-w-[75%] rounded-2xl border border-gray-200 bg-white px-4 py-3 text-gray-800 shadow-sm prose prose-sm"></div>';
            const content = msg.querySelector('div');
            content.innerHTML = renderContent(raw);
            messagesInner.appendChild(msg);
            if (persist) {
                history.push({ role: 'assistant', text: raw });
                saveHistory();
            }
            return content;
        }

        function saveHistory() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        function loadHistory() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            try { history = JSON.parse(saved); } catch { history = []; return; }
            messagesInner.innerHTML = '';
            for (const msg of history) {
                if (msg.role === 'user') appendUserMessage(msg.text, false);
                if (msg.role === 'assistant') appendAssistantMessage(msg.text, false);
            }
            scroll();
        }

        function formatToolInput(raw) {
            try {
                const obj = JSON.parse(raw);
                if (obj && typeof obj === 'object' && 'command' in obj) return String(obj.command);
            } catch {}
            return raw;
        }

        function decodeBase64Utf8(b64) {
            try {
                const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
                return new TextDecoder().decode(bytes);
            } catch {
                return b64;
            }
        }

        function escapeHtml(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        function scroll() { messagesInner.parentElement.scrollTop = messagesInner.parentElement.scrollHeight; }

        loadHistory();
        input.focus();
    </script>
</body>
</html>
